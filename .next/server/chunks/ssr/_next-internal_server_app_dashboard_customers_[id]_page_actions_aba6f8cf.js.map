{"version":3,"sources":["../../../../lib/actions/datasources.ts","../../../../lib/mangools/api.ts","../../../../lib/actions/domains.ts"],"sourcesContent":["\"use server\"\r\n\r\nimport { createClient } from \"@/lib/supabase/server\"\r\nimport { revalidatePath } from \"next/cache\"\r\nimport { z } from \"zod\"\r\n\r\nconst datasourceSchema = z.object({\r\n  customer_id: z.string().uuid(),\r\n  type: z.enum([\"mangools\", \"gsc\", \"ga4\", \"gbp\"]),\r\n  name: z.string().min(1, \"Name is required\"),\r\n  config: z.record(z.any()).optional(),\r\n})\r\n\r\ntype DatasourceInput = z.infer<typeof datasourceSchema>\r\n\r\n/**\r\n * Create a new datasource for a customer\r\n */\r\nexport async function createDatasource(input: DatasourceInput) {\r\n  try {\r\n    const validated = datasourceSchema.parse(input)\r\n    const supabase = await createClient()\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"datasources\")\r\n      .insert([\r\n        {\r\n          ...validated,\r\n          config: validated.config || {},\r\n        },\r\n      ])\r\n      .select()\r\n      .single()\r\n\r\n    if (error) throw new Error(error.message)\r\n\r\n    revalidatePath(`/dashboard/customers/${validated.customer_id}`)\r\n    return { success: true, data }\r\n  } catch (error) {\r\n    const message = error instanceof Error ? error.message : \"Failed to create datasource\"\r\n    console.error(\"Create datasource error:\", error)\r\n    return { success: false, error: message }\r\n  }\r\n}\r\n\r\n/**\r\n * Update a datasource\r\n */\r\nexport async function updateDatasource(id: string, input: Partial<DatasourceInput>) {\r\n  try {\r\n    const validated = datasourceSchema.partial().parse(input)\r\n    const supabase = await createClient()\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"datasources\")\r\n      .update({ ...validated, updated_at: new Date().toISOString() })\r\n      .eq(\"id\", id)\r\n      .select()\r\n      .single()\r\n\r\n    if (error) throw new Error(error.message)\r\n\r\n    revalidatePath(\"/dashboard\")\r\n    return { success: true, data }\r\n  } catch (error) {\r\n    const message = error instanceof Error ? error.message : \"Failed to update datasource\"\r\n    console.error(\"Update datasource error:\", error)\r\n    return { success: false, error: message }\r\n  }\r\n}\r\n\r\n/**\r\n * Delete a datasource\r\n */\r\nexport async function deleteDatasource(id: string) {\r\n  try {\r\n    const supabase = await createClient()\r\n\r\n    // Soft delete by setting is_active to false\r\n    const { error } = await supabase.from(\"datasources\").update({ is_active: false }).eq(\"id\", id)\r\n\r\n    if (error) throw new Error(error.message)\r\n\r\n    revalidatePath(\"/dashboard\")\r\n    return { success: true }\r\n  } catch (error) {\r\n    const message = error instanceof Error ? error.message : \"Failed to delete datasource\"\r\n    console.error(\"Delete datasource error:\", error)\r\n    return { success: false, error: message }\r\n  }\r\n}\r\n","import type { MangoolsApiDomain } from \"@/lib/supabase/types\"\r\nimport { cache } from \"react\"\r\n\r\nconst MANGOOLS_API_BASE = \"https://api.mangools.com/v3\"\r\n\r\n/**\r\n * Fetch available domains from Mangools SERPWatcher API\r\n * Returns all tracked domains from the account\r\n */\r\nexport const fetchMangoolsDomains = cache(async (): Promise<MangoolsApiDomain[]> => {\r\n  const accessToken = process.env.MANGOOLS_X_ACCESS_TOKEN\r\n\r\n  if (!accessToken) {\r\n    throw new Error(\"MANGOOLS_X_ACCESS_TOKEN environment variable is not set\")\r\n  }\r\n\r\n  try {\r\n    const response = await fetch(`${MANGOOLS_API_BASE}/serpwatcher/trackings`, {\r\n      method: \"GET\",\r\n      headers: {\r\n        \"x-access-token\": accessToken,\r\n        \"Content-Type\": \"application/json\",\r\n        Accept: \"*/*\",\r\n      },\r\n      next: {\r\n        revalidate: 300, // Cache for 5 minutes\r\n      },\r\n    })\r\n\r\n    if (!response.ok) {\r\n      const errorText = await response.text()\r\n      console.error(\"[Mangools API] Error response:\", errorText)\r\n      throw new Error(`Mangools API error: ${response.status} ${response.statusText}`)\r\n    }\r\n\r\n    const data = (await response.json()) as MangoolsApiDomain[]\r\n    \r\n    // Filter out deleted domains\r\n    const activeDomains = data.filter((domain) => !domain.is_deleted)\r\n    \r\n    return activeDomains\r\n  } catch (error) {\r\n    console.error(\"[Mangools API] Fetch failed:\", error)\r\n    throw error\r\n  }\r\n})\r\n\r\n/**\r\n * Parse Mangools domain data for storage\r\n * Extracts only the fields we need for our database\r\n */\r\nexport function parseMangoolsDomainForDb(domain: MangoolsApiDomain) {\r\n  return {\r\n    mangools_id: domain._id,\r\n    domain: domain.domain,\r\n    location_code: domain.location?.code ?? null,\r\n    location_label: domain.location?.label ?? null,\r\n    keywords_count: domain.count ?? 0,\r\n  }\r\n}\r\n","\"use server\"\r\n\r\nimport { createClient } from \"@/lib/supabase/server\"\r\nimport { revalidatePath } from \"next/cache\"\r\nimport { parseMangoolsDomainForDb } from \"@/lib/mangools/api\"\r\nimport type { MangoolsApiDomain } from \"@/lib/supabase/types\"\r\n\r\n/**\r\n * Attach a Mangools domain to a datasource\r\n */\r\nexport async function attachMangoolsDomain(datasourceId: string, domain: MangoolsApiDomain) {\r\n  try {\r\n    const supabase = await createClient()\r\n\r\n    // Parse domain data for storage\r\n    const domainData = parseMangoolsDomainForDb(domain)\r\n\r\n    // Insert or update the domain\r\n    const { data: insertedDomain, error: domainError } = await supabase\r\n      .from(\"mangools_domains\")\r\n      .upsert(\r\n        {\r\n          datasource_id: datasourceId,\r\n          ...domainData,\r\n          is_active: true,\r\n        },\r\n        {\r\n          onConflict: \"datasource_id,mangools_id\",\r\n        }\r\n      )\r\n      .select()\r\n      .single()\r\n\r\n    if (domainError) throw new Error(domainError.message)\r\n\r\n    revalidatePath(\"/dashboard\")\r\n    return { success: true, data: insertedDomain }\r\n  } catch (error) {\r\n    const message = error instanceof Error ? error.message : \"Failed to attach domain\"\r\n    console.error(\"Attach domain error:\", error)\r\n    return { success: false, error: message }\r\n  }\r\n}\r\n\r\n/**\r\n * Detach a Mangools domain from a datasource\r\n * Soft delete by setting is_active to false\r\n */\r\nexport async function detachMangoolsDomain(domainId: string) {\r\n  try {\r\n    const supabase = await createClient()\r\n\r\n    const { error } = await supabase.from(\"mangools_domains\").update({ is_active: false }).eq(\"id\", domainId)\r\n\r\n    if (error) throw new Error(error.message)\r\n\r\n    revalidatePath(\"/dashboard\")\r\n    return { success: true }\r\n  } catch (error) {\r\n    const message = error instanceof Error ? error.message : \"Failed to detach domain\"\r\n    console.error(\"Detach domain error:\", error)\r\n    return { success: false, error: message }\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}